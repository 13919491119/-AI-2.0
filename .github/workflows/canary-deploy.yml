name: Canary Deploy (manual, safe)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Set to true to perform real deployment. Otherwise only dry-run.'
        required: true
        default: 'false'
      namespace:
        description: 'Kubernetes namespace to deploy into'
        required: false
        default: 'canary'
      metrics_endpoint:
        description: 'Optional metrics endpoint for simple monitoring (http(s) URL)'
        required: false
        default: ''
      monitor_duration:
        description: 'Monitoring duration in seconds after deploy'
        required: false
        default: '300'
      monitor_interval:
        description: 'Monitoring poll interval in seconds'
        required: false
        default: '30'
      rollback_threshold:
        description: 'Simple numeric threshold (if metric > threshold then rollback). Workflow assumes metrics endpoint returns a single numeric value.'
        required: false
        default: '0'

jobs:
  validate:
    name: Validate manifests (dry-run)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" 
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: Dry-run kubectl apply
        run: |
          ns="${{ github.event.inputs.namespace }}"
          echo "Performing client-side dry-run for namespace=$ns"
          kubectl apply -n "$ns" -f artifacts/manifests/canary-deployment.yaml --dry-run=client || true

  deploy:
    name: Deploy and monitor (requires confirm=true)
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.event.inputs.confirm == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl and jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl jq
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" 
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: Decode kubeconfig from secret
        env:
          KUBE_B64: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          if [ -z "$KUBE_B64" ]; then echo "KUBE_CONFIG_DATA secret not set"; exit 1; fi
          mkdir -p $GITHUB_WORKSPACE/.kube
          echo "$KUBE_B64" | base64 -d > $GITHUB_WORKSPACE/.kube/config
          export KUBECONFIG=$GITHUB_WORKSPACE/.kube/config
          kubectl --kubeconfig=$GITHUB_WORKSPACE/.kube/config version --short

      - name: Apply canary manifest
        env:
          NAMESPACE: ${{ github.event.inputs.namespace }}
        run: |
          echo "Applying canary manifest into namespace=$NAMESPACE"
          kubectl --kubeconfig=$GITHUB_WORKSPACE/.kube/config apply -n "$NAMESPACE" -f artifacts/manifests/canary-deployment.yaml

      - name: Simple monitoring and auto-rollback
        env:
          METRICS_URL: ${{ github.event.inputs.metrics_endpoint }}
          DURATION: ${{ github.event.inputs.monitor_duration }}
          INTERVAL: ${{ github.event.inputs.monitor_interval }}
          THRESH: ${{ github.event.inputs.rollback_threshold }}
          NAMESPACE: ${{ github.event.inputs.namespace }}
        run: |
          if [ -z "$METRICS_URL" ] || [ "$METRICS_URL" = "" ]; then echo "No metrics endpoint provided; skipping monitoring"; exit 0; fi
          echo "Monitoring $METRICS_URL for $DURATION seconds (interval $INTERVAL) with threshold $THRESH"
          deadline=$(( $(date +%s) + DURATION ))
          while [ $(date +%s) -lt $deadline ]; do
            set +e
            val=$(curl -sS "$METRICS_URL" | tr -d '\n' | tr -d '[:space:]')
            set -e
            if [ -z "$val" ]; then echo "no metric value returned"; sleep $INTERVAL; continue; fi
            # Expect a plain numeric metric
            if ! echo "$val" | jq -R 'tonumber' >/dev/null 2>&1; then
              echo "metric is not a number: $val"; sleep $INTERVAL; continue
            fi
            num=$(echo "$val" | jq -R 'tonumber')
            echo "metric value: $num"
            cmp=$(echo "$num > $THRESH" | bc -l 2>/dev/null || echo 0)
            if [ "$cmp" -eq 1 ]; then
              echo "Threshold breached (value $num > $THRESH). Triggering rollback."
              # attempt rollback of rollout-enabled resources in the manifest using kubectl rollout undo
              # here we assume Deployment named 'xuanji-canary' - fallback to kubectl rollout undo for all deployments in namespace with label app=xuanji-canary
              kubectl --kubeconfig=$GITHUB_WORKSPACE/.kube/config -n "$NAMESPACE" rollout undo deployment/xuanji-canary || true
              echo "Rollback attempted"; exit 0
            fi
            sleep $INTERVAL
          done
          echo "Monitoring finished without threshold breach"
