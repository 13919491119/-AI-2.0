name: CI - Auto Deploy (phase-C blueprint)

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  validate-and-package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
      - name: Run smoke train (offline evaluation)
        run: |
          # NOTE: This should be limited in CI to a very small smoke run
          python3 experiments/train.py --min-samples 10 || true
      - name: Package model artifact
        run: |
          python3 tools/package_model.py --model-path ssq_ai_model_state.json --out-dir artifacts
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: model-artifact
          path: artifacts/**

  post-deploy-controller:
    needs: validate-and-package
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }} # manual trigger only for auto-deploy in this template
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: model-artifact
      - name: Approve and deploy to canary (DRY-RUN mode by default)
        env:
          DRY_RUN: 'true'
        run: |
          # This step expects deployment credentials to be provided via secrets
          # Example secrets: KUBE_CONFIG_DATA, DEPLOY_SERVICE_ACCOUNT, REGISTRY_KEY
          ./tools/deploy_canary.sh --artifact artifacts --namespace canary --dry-run=${DRY_RUN}

  monitor-and-rollback:
    needs: post-deploy-controller
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Monitor canary metrics
        run: |
          python3 tools/auto_rollback.py --canary-endpoint http://canary.metrics.local/metrics --threshold-file tools/rollback_thresholds.json

# WARNING: This is a template. To enable actual automatic merge/deploy you MUST:
# - Configure CI secrets (KUBECONFIG / SSH / tokens)
# - Limit CI service account privileges and enable audit logging
# - Enable branch protection rules and require status checks
