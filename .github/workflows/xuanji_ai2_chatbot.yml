# GitHub Actions 工作流：自动监听 Issue/PR 评论，调用玄机AI2.0 API 并自动回复
# 使用前请在仓库 Secrets 配置 GITHUB_TOKEN 和 XUANJI_API_URL

name: XuanjiAI2.0 ChatBot

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  discussion_comment:
    types: [created]

jobs:
  xuanji_ai2:
    runs-on: ubuntu-latest
    steps:
      - name: 检查评论内容
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # 安装 axios 以便在脚本中使用
          packages: '["axios"]'
          script: |
            const axios = require('axios');
            const comment = context.payload.comment.body;
            const eventName = process.env.GITHUB_EVENT_NAME;
            console.log('收到事件:', eventName);
            if (comment && comment.includes('运行玄机AI2.0')) {
              try {
                const apiUrl = process.env.XUANJI_API_URL || 'http://你的API地址:8000/run_xuanji_ai';
                const resp = await axios.post(apiUrl, { input: comment }, { timeout: 30000 });
                const result = resp.data.result || '[AI2.0无响应]';
                // 回复评论
                const commentUrl = context.payload.comment.url;
                await github.request('POST ' + commentUrl + '/replies', {
                  body: `[玄机AI2.0自动回复]:\n${result}`
                });
                console.log('已自动回复AI2.0结果');
              } catch (err) {
                console.log('AI2.0 API调用失败:', err.message);
                const commentUrl = context.payload.comment.url;
                await github.request('POST ' + commentUrl + '/replies', {
                  body: `[AI2.0自动回复失败]: ${err.message}`
                });
              }
            }
