name: Auto Full Autonomy (Phase C) - template

# WARNING: Template for fully-autonomous pipeline. WILL NOT RUN unless the required secrets
# are configured and branch protection/organization policies allow auto-merge/deploy.
jobs:
  full-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Guard for Phase C (set step output 'enabled')
        id: guard
        env:
          ENABLE_PHASE_C: ${{ secrets.ENABLE_PHASE_C }}
        run: |
          # Decide whether to run the full pipeline based on ENABLE_PHASE_C secret.
          # Write output to GITHUB_OUTPUT so subsequent steps can reference it without
          # putting secrets into job-level 'if' expressions (avoids editor diagnostics).
          if [ "${ENABLE_PHASE_C}" = "true" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Run full pipeline (guarded)
        if: steps.guard.outputs.enabled == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
          AUTO_MERGE: ${{ secrets.AUTO_MERGE }}
          DRY_RUN: ${{ secrets.DRY_RUN }}
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip || true
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          pytest -q || true
          python3 experiments/train.py --min-samples 10 || true
          python3 tools/package_model.py --model-path ssq_ai_model_state.json --out-dir artifacts || true
          python3 tools/model_registry.py register artifacts || true

          # Create upgrade PR if GH_TOKEN is provided
          if [ -n "${GH_TOKEN:-}" ]; then
            git checkout -b xuanji/autoupdate-$(date +%s)
            git add artifacts || true
            git commit -m "chore: auto-packaged model artifact" || true
            git push --set-upstream origin HEAD || true
            gh pr create --title "Auto: packaged model" --body "Automated model packaging (phase C)" || true
          else
            echo "GH_TOKEN not provided; skipping PR creation"
          fi

          # Auto-merge & deploy (runtime guarded)
          if [ "${AUTO_MERGE:-}" = "true" ] && [ "${DRY_RUN:-true}" = "false" ]; then
            if [ -z "${GH_TOKEN:-}" ] || [ -z "${KUBE_CONFIG_DATA:-}" ]; then
              echo "Required secrets for auto-merge/deploy missing; skipping"
            else
              ./tools/auto_merge_and_deploy.sh --pr-title "Auto: packaged model" --dry-run=false || true
            fi
          else
            echo "AUTO_MERGE not enabled or DRY_RUN not false; skipping auto-merge/deploy"
          fi
          git commit -m "chore: auto-packaged model artifact" || true
          git push --set-upstream origin HEAD
          gh pr create --title "Auto: packaged model" --body "Automated model packaging (phase C)" || true
      - name: Auto-merge PR and deploy to canary (unsafe - requires secrets)
        run: |
          # runtime guard: ensure feature enabled and secrets present
          if [ "${{ secrets.AUTO_MERGE }}" != "true" ]; then
            echo "AUTO_MERGE != true; skipping auto-merge/deploy"
            exit 0
          fi
          # DRY_RUN secret controls whether the workflow should actually perform merge/deploy.
          # Convention: set secrets.DRY_RUN=false to allow real actions. Default (unset/true)
          # keeps the workflow in safe dry-run mode and will skip merge/deploy.
          if [ "${{ secrets.DRY_RUN }}" != "false" ]; then
            echo "DRY_RUN != false (safe default); skipping auto-merge/deploy"
            exit 0
          fi

          if [ -z "${{ secrets.GH_TOKEN }}" ] || [ -z "${{ secrets.KUBE_CONFIG_DATA }}" ]; then
            echo "Required secrets (GH_TOKEN or KUBE_CONFIG_DATA) missing; skipping"
            exit 0
          fi
          echo "DRY RUN: set DRY_RUN=false in secrets to enable actual merge/deploy"
          ./tools/auto_merge_and_deploy.sh --pr-title "Auto: packaged model" --dry-run=true || true

  monitor-loop:
    runs-on: ubuntu-latest
    needs: full-pipeline
    steps:
      - name: Monitor canary and auto rollback (template)
        run: |
          if [ "${{ secrets.ENABLE_PHASE_C }}" != "true" ]; then
            echo "Phase C disabled; skipping monitor"
            exit 0
          fi
          if [ -z "${{ secrets.CANARY_METRICS_URL }}" ]; then
            echo "CANARY_METRICS_URL not set; skipping monitor"
            exit 0
          fi
          python3 tools/auto_rollback.py --canary-endpoint "${{ secrets.CANARY_METRICS_URL }}" --threshold-file tools/rollback_thresholds.json || true
