<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ç„æœºAI è¿ç»´ä»ªè¡¨ç›˜</title>
  <link rel="stylesheet" href="/static/report.css" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; }
    .container { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    h1 { margin-bottom: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .links a { display: block; margin: 8px 0; color: #2563eb; text-decoration: none; }
    .links a:hover { text-decoration: underline; }
    .note { color: #6b7280; font-size: 14px; }
    .kv { display:flex; gap:8px; align-items:center; margin:6px 0; }
    .kv label { width: 210px; color:#374151; }
  </style>
  <script>
    async function ping(url, id){
      const el = document.getElementById(id);
      try {
        const res = await fetch(url, { method: 'GET' });
        el.textContent = res.ok ? 'UP' : ('DOWN ('+res.status+')');
        el.style.color = res.ok ? '#16a34a' : '#dc2626';
      } catch(e){
        el.textContent = 'DOWN'; el.style.color = '#dc2626';
      }
    }
    async function loadPublicUrls(){
      try {
        const res = await fetch('/static/public_urls.json', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        const box = document.getElementById('publicUrls');
        if (!box) return;
        const urls = data.urls || {};
        let html = '';
        if (urls.report_frontend_8080) html += `<div><a target="_blank" href="${urls.report_frontend_8080}">å…¬ç½‘-åŠ¨æ€æŠ¥å‘Š (8080)</a></div>`;
  if (urls.static_8088) html += `<div><a target="_blank" href="${urls.static_8088}/status_report.html">å…¬ç½‘-é™æ€æŠ¥å‘Š (8088)</a></div>`;
  if (urls.static_8088) html += `<div><a target="_blank" href="${urls.static_8088}/operation_report_latest.html">å…¬ç½‘-è¿è¥å‘¨æœŸæŠ¥å‘Šï¼ˆæœ€æ–°ï¼‰</a></div>`;
  if (urls.static_8088) html += `<div><a target="_blank" href="${urls.static_8088}/operation_report_latest.md">å…¬ç½‘-è¿è¥å‘¨æœŸæŠ¥å‘Šï¼ˆæœ€æ–°Â·Markdownï¼‰</a></div>`;
        if (urls.api_8000) html += `<div><a target="_blank" href="${urls.api_8000}/status">å…¬ç½‘-API /status (8000)</a></div>`;
        if (!html) html = '<div class="note">æœªæ‰¾åˆ°å…¬ç½‘é“¾æ¥ï¼ˆè¯·é…ç½® NGROK_AUTH_TOKEN å¹¶ç­‰å¾…éš§é“å»ºç«‹ï¼‰ã€‚</div>';
        box.innerHTML = html + `<div class="note">æ›´æ–°æ—¶é—´ï¼š${data.timestamp || ''}</div>`;
      } catch(e) {}
    }
    async function loadTimes(){
      const utcEl = document.getElementById('utcTime');
      const localEl = document.getElementById('localTime');
      const tzEl = document.getElementById('tzName');
      const loadedEl = document.getElementById('timesLoadedAt');
      try {
        const res = await fetch('/static/status.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('status.json not available');
        const data = await res.json();
        utcEl.textContent = data.timestamp || 'ä¸å¯ç”¨';
        localEl.textContent = data.local_time || 'ä¸å¯ç”¨';
        tzEl.textContent = data.timezone ? `ï¼ˆ${data.timezone}ï¼‰` : '';
        const now = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        loadedEl.textContent = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      } catch(e) {
        utcEl.textContent = 'ä¸å¯ç”¨';
        localEl.textContent = 'ä¸å¯ç”¨';
        tzEl.textContent = '';
        loadedEl.textContent = '';
      }
    }
    window.addEventListener('DOMContentLoaded', () => {
      ping('http://127.0.0.1:8000/health', 'apiStatus');
      ping('http://127.0.0.1:8080/status_report', 'dynamicStatus');
      ping('http://127.0.0.1:8088/status_report.html', 'staticStatus');
      loadPublicUrls();
      loadTimes();
      setInterval(loadTimes, 30000);
    });
    async function loadInternetSelfTest(){
      try {
        const res = await fetch('/static/internet_self_test.json', { cache: 'no-store' });
        const box = document.getElementById('internetSelfTestBox');
        if (!box) return;
        if (!res.ok) { box.innerHTML = '<div class="note">å°šæœªæ‰§è¡Œè¿‡è‡ªæ£€</div>'; return; }
        const data = await res.json();
        const ts = data.timestamp || '-';
        const urlOk = data.url_test && data.url_test.ok === true;
        const searchOk = data.search_test && data.search_test.ok === true;
        const badge = (ok)=> `<span style="padding:2px 6px; border-radius:6px; color:#fff; background:${ok?'#16a34a':'#dc2626'};">${ok?'é€šè¿‡':'å¤±è´¥'}</span>`;
        box.innerHTML = `
          <div class='kv'><label>æœ€è¿‘è‡ªæ£€æ—¶é—´ï¼š</label> <b>${ts}</b></div>
          <div class='kv'><label>URL ç›´è¿ï¼š</label> ${badge(urlOk)}</div>
          <div class='kv'><label>æœç´¢èšåˆï¼š</label> ${badge(searchOk)} <span class='note' style='margin-left:8px;'>(æœªé…ç½® Key æ—¶å°†é™çº§ä¸ºæœ¬åœ°æ‘˜è¦)</span></div>
        `;
      } catch(e) {}
    }
    window.addEventListener('DOMContentLoaded', () => {
      loadInternetSelfTest();
      setInterval(loadInternetSelfTest, 60000);
    });
  </script>
  </head>
<body>
  <div class="container">
    <h1>ğŸ”­ ç„æœºAI è¿ç»´ä»ªè¡¨ç›˜</h1>
    <div class="card">
      <h2>å³æ—¶è°ƒä¼˜æ‘˜è¦</h2>
      <div id="tuneBox" class="note">åŠ è½½ä¸­...</div>
      <script>
        async function loadTuneSummary(){
          const box = document.getElementById('tuneBox');
          try{
            const res = await fetch('/static/tuning_summary.json', { cache: 'no-store' });
            if(!res.ok){ box.textContent = 'æš‚æ— è°ƒä¼˜æ‘˜è¦'; return; }
            const s = await res.json();
            const w = s.weights || {}; const m = s.metrics || {};
            const fmtW = Object.keys(w).length ? Object.entries(w).map(([k,v])=>`${k}: ${v}`).join(', ') : '-';
            box.innerHTML = `
              <div class='note'>å¿«ç…§ï¼š${s.generated_local || s.generated_utc || '-'}</div>
              <div class='kv'><label>çª—å£æœŸï¼š</label> <b>${s.window ?? '-'}</b></div>
              <div class='kv'><label>EMAï¼š</label> <b>${s.ema_alpha ?? '-'}</b></div>
              <div class='kv'><label>èåˆæƒé‡ï¼š</label> <b>${fmtW}</b></div>
            `;
          }catch(e){ box.textContent = 'åŠ è½½å¤±è´¥'; }
        }
        window.addEventListener('DOMContentLoaded', ()=>{ loadTuneSummary(); setInterval(loadTuneSummary, 60000); });
      </script>
    </div>
      <h2>æœåŠ¡çŠ¶æ€</h2>
      <ul>
        <li>API (8000): <b id="apiStatus">æ£€æŸ¥ä¸­...</b></li>
        <li>åŠ¨æ€çŠ¶æ€æŠ¥å‘Š (8080): <b id="dynamicStatus">æ£€æŸ¥ä¸­...</b></li>
        <li>é™æ€çŠ¶æ€æŠ¥å‘Š (8088): <b id="staticStatus">æ£€æŸ¥ä¸­...</b></li>
      </ul>
      <p class="note">æ³¨ï¼šåŠ¨æ€é¡µé¢ä¾èµ– uvicorn/fastapiï¼Œé™æ€é¡µé¢ä¸ä¾èµ–ã€‚</p>
    </div>
    <div class="card links">
      <h2>å¿«æ·å…¥å£</h2>
      <a href="http://127.0.0.1:8000/status" target="_blank">API /status</a>
      <a href="http://127.0.0.1:8000/health" target="_blank">API /health</a>
      <a href="http://127.0.0.1:8080/report" target="_blank">è¿è¥æŠ¥å‘Šå‰ç«¯ /report</a>
      <a href="http://127.0.0.1:8080/operation_report" target="_blank">è¿è¥å‘¨æœŸæŠ¥å‘Šï¼ˆåŠ¨æ€ï¼‰</a>
      <a href="http://127.0.0.1:8080/status_report" target="_blank">åŠ¨æ€â€œè¿è¡ŒçŠ¶æ€æŠ¥å‘Šâ€</a>
  <a href="http://127.0.0.1:8088/status_report.html" target="_blank">é™æ€â€œè¿è¡ŒçŠ¶æ€æŠ¥å‘Šâ€</a>
  <a href="http://127.0.0.1:8088/operation_report_latest.html" target="_blank">é™æ€â€œè¿è¥å‘¨æœŸæŠ¥å‘Šï¼ˆæœ€æ–°ï¼‰â€</a>
  <a href="http://127.0.0.1:8088/operation_report_latest.md" target="_blank">é™æ€â€œè¿è¥å‘¨æœŸæŠ¥å‘Šï¼ˆæœ€æ–°Â·Markdownï¼‰â€</a>
      <div style="margin-top:8px;">
        <span class="note">é™æ€æŠ¥å‘Šåˆ†æ®µç›´è¾¾ï¼š</span>
        <div class="links">
          <a href="http://127.0.0.1:8088/status_report.html#sec-status" target="_blank">è¿›ç¨‹çŠ¶æ€</a>
          <a href="http://127.0.0.1:8088/status_report.html#sec-autonomous" target="_blank">å­¦ä¹ /å¤ç›˜æ—¥å¿—</a>
          <a href="http://127.0.0.1:8088/status_report.html#sec-predict" target="_blank">åŒè‰²çƒé¢„æµ‹æ—¥å¿—</a>
          <a href="http://127.0.0.1:8088/status_report.html#sec-optimize" target="_blank">ä¼˜åŒ–å¾ªç¯æ—¥å¿—</a>
          <a href="http://127.0.0.1:8088/status_report.html#sec-person" target="_blank">å†å²äººç‰©ä»»åŠ¡æ—¥å¿—</a>
          <a href="http://127.0.0.1:8088/status_report.html#sec-api" target="_blank">API æ—¥å¿—</a>
        </div>
        <div class="links" style="margin-top:6px;">
          <a href="http://127.0.0.1:8088/operation_report.html" target="_blank">é™æ€â€œè¿è¥å‘¨æœŸæŠ¥å‘Šâ€</a>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>æ—¶é—´/æ—¶åŒº</h2>
      <div class="kv"><label>ç³»ç»Ÿæ—¶é—´ï¼ˆUTCï¼‰ï¼š</label> <b id="utcTime">åŠ è½½ä¸­...</b></div>
      <div class="kv"><label>åŒ—äº¬æ—¶é—´<span id="tzName">ï¼ˆAsia/Shanghaiï¼‰</span>ï¼š</label> <b id="localTime">åŠ è½½ä¸­...</b></div>
      <div class="kv"><label>æœ€è¿‘åŠ è½½ï¼š</label> <span id="timesLoadedAt" class="note">-</span></div>
      <div style="margin-top:8px;">
        <button onclick="loadTimes()" style="padding:6px 10px; border:1px solid #e5e7eb; border-radius:6px; background:#fafafa; cursor:pointer;">æ‰‹åŠ¨åˆ·æ–°</button>
      </div>
      <p class="note">ä¸Šè¿°æ—¶é—´æ¥è‡ª <code>/static/status.json</code> å¿«ç…§ï¼ˆæ¯ ~10s æ›´æ–°ä¸€æ¬¡ï¼‰ã€‚</p>
    </div>
    <div class="card">
      <h2>åå°ä»»åŠ¡å¿ƒè·³ä¸æœ€è¿‘æ‘˜è¦</h2>
      <div id="hbBox" class="note">åŠ è½½ä¸­...</div>
      <script>
        async function loadHeartbeats(){
          const box = document.getElementById('hbBox');
          try{
            const res = await fetch('/static/status.json', { cache: 'no-store' });
            if(!res.ok){ box.textContent = 'æš‚æ— å¿ƒè·³å¿«ç…§'; return; }
            const data = await res.json();
            const hb = data.heartbeats || {};
            const fmtTail = (t)=> t ? `<pre style='margin-top:8px;'>${t.replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]))}</pre>` : '';
            const row = (name, h) => {
              if(!h) h = {};
              const ok = (h.status||'').toUpperCase()==='RUNNING';
              const badge = `<span style="padding:2px 6px; border-radius:6px; color:#fff; background:${ok?'#16a34a':'#dc2626'};">${h.status||'UNKNOWN'}</span>`;
              return `
                <div style='border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin:10px 0;'>
                  <div class='kv'><label>${name}ï¼š</label> ${badge} <span class='note' style='margin-left:6px;'>pid=${h.pid??'-'} uptime=${h.uptime??'-'}</span></div>
                  <div class='kv'><label>æœ€è¿‘æ—¥å¿—æ—¶é—´ï¼š</label> <b>${h.last_log_time||'-'}</b></div>
                  ${fmtTail(h.last_tail||'')}
                </div>`
            };
            box.innerHTML = row('xuanji_predict', hb['xuanji_predict']) + row('xuanji_person', hb['xuanji_person']);
          }catch(e){ box.textContent = 'åŠ è½½å¤±è´¥'; }
        }
        window.addEventListener('DOMContentLoaded', ()=>{ loadHeartbeats(); setInterval(loadHeartbeats, 30000); });
      </script>
    </div>
    <div class="card">
      <h2>å…¬ç½‘è®¿é—®ï¼ˆå¯é€‰ï¼‰</h2>
      <div id="publicUrls" class="links"></div>
      <p class="note">å¦‚éœ€è‡ªåŠ¨ç”Ÿæˆå…¬ç½‘é“¾æ¥ï¼Œè¯·åœ¨ <code>.env</code> è®¾ç½® <code>NGROK_AUTH_TOKEN</code> å¹¶ç­‰å¾…çº¦10ç§’ï¼›ä¹Ÿå¯å‚è€ƒ <code>PUBLIC_ACCESS_CONFIGURATION.md</code> é‡‡ç”¨ FRP/Nginxã€‚</p>
    </div>
    <div class="card">
      <h2>äº’è”ç½‘è‡ªæ£€</h2>
      <div class="links">
        <a href="http://127.0.0.1:8080/internet_self_test" target="_blank">æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡è‡ªæ£€ç»“æœï¼ˆåŠ¨æ€ï¼‰</a>
        <a href="/static/internet_self_test.json" target="_blank">æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡è‡ªæ£€ JSONï¼ˆé™æ€ï¼‰</a>
      </div>
      <div id="internetSelfTestBox"></div>
      <p class="note">è‹¥å°šæœªæ‰§è¡Œè‡ªæ£€ï¼Œè¯·è¿è¡Œ <code>tools/self_test_internet.py</code>ã€‚è‡ªæ£€å°†ç›´æ¥æŠ“å–å®˜ç½‘å¹¶å°è¯•æ£€ç´¢èšåˆã€‚</p>
    </div>
    <div class="card">
      <h2>è¿è¥å‘¨æœŸæŠ¥å‘Šæ‘˜è¦</h2>
      <div id="opSummaryBox" class="note">åŠ è½½ä¸­...</div>
      <div class="links" style="margin-top:8px;">
        <a href="http://127.0.0.1:8080/operation_report" target="_blank">æŸ¥çœ‹åŠ¨æ€æŠ¥å‘Š</a>
        <a href="http://127.0.0.1:8088/operation_report.html" target="_blank">æŸ¥çœ‹é™æ€æŠ¥å‘Š</a>
      </div>
      <script>
        async function loadOpSummary(){
          const box = document.getElementById('opSummaryBox');
          try{
            const res = await fetch('/static/operation_summary.json', { cache: 'no-store' });
            if(!res.ok){ box.textContent = 'æš‚æ— è¿è¥æŠ¥å‘Šæ‘˜è¦'; return; }
            const s = await res.json();
            const core = s.core || {}; const ssq = s.ssq || {};
            const row = (k,v)=> `<div class='kv'><label>${k}ï¼š</label> <b>${(v??'-')}</b></div>`;
            box.innerHTML = `
              <div class='note'>æ–‡ä»¶ï¼š${s.file||'-'}ï½œæŠ¥å‘Šæ—¶é—´ï¼š${s.report_time||'-'}ï½œå¿«ç…§ï¼š${s.generated_local||s.generated_utc||'-'}</div>
              <h3 style='margin:10px 0 6px;'>æ ¸å¿ƒæŒ‡æ ‡</h3>
              ${row('ç´¯è®¡å­¦ä¹ å‘¨æœŸ', core['ç´¯è®¡å­¦ä¹ å‘¨æœŸ'])}
              ${row('ç³»ç»Ÿä¼˜åŒ–è¿›åº¦', core['ç³»ç»Ÿä¼˜åŒ–è¿›åº¦'])}
              ${row('ç³»ç»Ÿè‡ªä¸»å‡çº§', core['ç³»ç»Ÿè‡ªä¸»å‡çº§'])}
              ${row('æ€§èƒ½æå‡å€æ•°', core['æ€§èƒ½æå‡å€æ•°'])}
              <h3 style='margin:14px 0 6px;'>åŒè‰²çƒæŒ‡æ ‡</h3>
              ${row('å­¦ä¹ å‘¨æœŸ', ssq['åŒè‰²çƒå­¦ä¹ å‘¨æœŸ'])}
              ${row('å®Œå…¨åŒ¹é…æ¬¡æ•°', ssq['å®Œå…¨åŒ¹é…æ¬¡æ•°'])}
              ${row('æ¨¡å‹æƒé‡åˆ†å¸ƒ', ssq['æ¨¡å‹æƒé‡åˆ†å¸ƒ'])}
            `;
          }catch(e){ box.textContent = 'åŠ è½½å¤±è´¥'; }
        }
        window.addEventListener('DOMContentLoaded', ()=>{ loadOpSummary(); setInterval(loadOpSummary, 60000); });
      </script>
      </div>

      <div class="card" id="self-heal-alert">
        <h2>è‡ªæ„ˆç­–ç•¥å‘Šè­¦</h2>
        <pre id="self-heal-log">åŠ è½½ä¸­...</pre>
        <script>
          async function loadSelfHealLog(){
            const box = document.getElementById('self-heal-log');
            try{
              const res = await fetch('/static/self_heal_log.txt', { cache: 'no-store' });
              if(!res.ok){ box.textContent = 'æš‚æ— è‡ªæ„ˆæ—¥å¿—'; return; }
              const t = await res.text();
              box.textContent = t.split('\n').slice(-10).join('\n');
            }catch(e){ box.textContent = 'åŠ è½½å¤±è´¥'; }
          }
          window.addEventListener('DOMContentLoaded', ()=>{ loadSelfHealLog(); setInterval(loadSelfHealLog, 60000); });
        </script>
    </div>
    <div class="card">
      <h2>è”ç½‘æ£€ç´¢ï¼ˆå®éªŒæ€§ï¼‰</h2>
      <div class="kv"><label>æŸ¥è¯¢ï¼š</label> <input id="webQuery" placeholder="ä¾‹å¦‚ï¼šè”ç½‘æŸ¥è¯¢: é‡å­è®¡ç®— æœ€æ–°è¿›å±• æˆ– url:https://www.python.org/" style="flex:1; width:100%; padding:6px; border:1px solid #e5e7eb; border-radius:6px;" /></div>
      <div style="margin-top:8px;"><button id="runWebSearch" style="padding:6px 10px; border:1px solid #e5e7eb; border-radius:6px; background:#fafafa; cursor:pointer;">æ‰§è¡Œæ£€ç´¢</button></div>
      <pre id="webSearchResult" style="margin-top:10px; white-space:pre-wrap; word-break:break-word;"></pre>
      <script>
        document.getElementById('runWebSearch').addEventListener('click', async () => {
          const q = document.getElementById('webQuery').value || '';
          const box = document.getElementById('webSearchResult');
          if (!q.trim()) { box.textContent = 'è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹'; return; }
          box.textContent = 'æ£€ç´¢ä¸­...';
          try {
            const resp = await fetch('http://127.0.0.1:8080/web_research', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query: q, max_results: 3 })
            });
            const data = await resp.json();
            if (!resp.ok) { box.textContent = 'é”™è¯¯ï¼š' + (data.error || resp.status); return; }
            const sources = (data.sources || []).map(u => `- ${u}`).join('\n');
            box.textContent = `æ‘˜è¦:\n${data.summary || ''}\n\næ¥æº:\n${sources || '(æ— )'}`;
          } catch (e) {
            box.textContent = 'è°ƒç”¨å¤±è´¥ï¼š' + e;
          }
        });
      </script>
      <p class="note">æç¤ºï¼šæœªé…ç½® SERPAPI/Bing Key æ—¶ï¼Œèšåˆæœç´¢ä¼šé™çº§ä¸ºæœ¬åœ°æ‘˜è¦ï¼›å¯ç”¨ <code>url:https://</code> ç›´æ¥æŠ“å–ã€‚</p>
    </div>
    <p class="note">æœ¬é¡µé¢ç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œå¯ç”¨äºæœ¬åœ°è¿ç»´ä¸å¿«é€Ÿè·³è½¬ã€‚</p>
  </div>
 </body>
</html>
